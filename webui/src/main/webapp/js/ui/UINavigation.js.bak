define([
  'jquery',
  'underscore', 
  'backbone',
  'text!ui/UINavigation.jtpl'
], function($, _, Backbone, Template) {
  var Menu = function(menu) {
    this.menu = menu;

    this.addItem = function(label, onClick) {
      var item = {label: label, onClick: onClick };
      this.menu.items.push(item);
    };
  };

  var UINavigation = Backbone.View.extend({
    initialize: function(options) {
      this.state = {
        nav: { 
          width: 200, collapse: false, menus: {},
        },
      };
      if(this.config.nav) {
        if(this.config.nav.width) this.state.nav.width = this.config.nav.width;
      }
      if(this.onInit) this.onInit(options);
    },

    addMenu: function(name, label, collapse) {
      var menu = { name: name, label: label, collapse: collapse, items: [] };
      this.state.nav.menus[name] = menu;
      return new Menu(menu);
    },

    setWorkspace: function(uiComponent) {
      this.uiWSComponent = uiComponent;
      $(this.el).find('.ui-navigation-ws').empty();
      $(this.el).find('.ui-navigation-ws').unbind();
      uiComponent.setElement(this.$('.ui-navigation-ws')).render();
    },
    
    _template: _.template(Template),

    render: function() {
      var params = { 
        config: this.config,
        state:  this.state
      } ;
      $(this.el).html(this._template(params));
    },

    events: {
      'click .onToggleControl': 'onToggleControl',
      'click .onSelectMenuItem': 'onSelectMenuItem'
    },

    onToggleControl: function(evt) {
      this.state.nav.collapse = !this.state.nav.collapse;
      var uiNavBlk = $(evt.target).closest(".ui-navigation");
      var uiNavCtrlBlk = uiNavBlk.find(".ui-navigation-ctrl").first();
      var uiNavWSBlk = uiNavBlk.find(".ui-navigation-ws").first();
      if(this.state.nav.collapse) {
        uiNavCtrlBlk.css("width", "25px");
        uiNavCtrlBlk.find(".ui-navigation-ctrl-menu").css("display", "none");
        uiNavWSBlk.css("margin-left","25px");
        $(evt.target).text(">>");
      } else {
        var splitW = this.state.nav.width + "px";
        uiNavCtrlBlk.css("width", splitW);
        uiNavCtrlBlk.find(".ui-navigation-ctrl-menu").css("display", "block");
        uiNavWSBlk.css("margin-left", splitW);
        $(evt.target).text("<<");
      }
    },

    onSelectMenuItem: function(evt) {
      var menuName = $(evt.target).attr("menu") ;
      var itemIdx = $(evt.target).attr("itemIdx") ;
      var menu = this.state.nav.menus[menuName];
      var menuItem = menu.items[itemIdx];
      menuItem.onClick(this, menu, menuItem);
    }
  });
  
  return UINavigation ;
});
